name: Build TFLite with Flex (TensorFlow 2.19)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 500
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo apt-get clean
        df -h
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build TFLite 2.19 from source
      run: |
        docker run --name builder \
          ubuntu:24.04 \
          bash -c "
            set -e
            
            echo '=== Installing dependencies ==='
            apt-get update
            apt-get install -y \
              git wget curl \
              build-essential \
              software-properties-common \
              openjdk-11-jdk \
              zip unzip
            
            echo '=== Installing Python 3.10 ==='
            add-apt-repository ppa:deadsnakes/ppa -y
            apt-get update
            apt-get install -y python3.10 python3.10-dev python3.10-distutils
            
            # Python 3.10을 기본으로 설정
            update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
            
            # pip 설치 (Python 3.10용)
            curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10
            
            python3 --version
            python3 -m pip --version \
              software-properties-common
            
            echo '=== Installing GCC 12 for AVX512FP16 support ==='
            add-apt-repository ppa:ubuntu-toolchain-r/test -y
            apt-get update
            apt-get install -y gcc-12 g++-12
            update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
            update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
            gcc --version
            
            echo '=== Installing Bazel 6.5.0 ==='
            wget -q https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-linux-x86_64 -O /usr/local/bin/bazel
            chmod +x /usr/local/bin/bazel
            bazel --version
            
            echo '=== Cloning TensorFlow 2.19.0 ==='
            git clone --depth 1 --branch v2.19.0 https://github.com/tensorflow/tensorflow.git /tensorflow_src
            cd /tensorflow_src
            
            echo '=== Installing Python dependencies ==='
            python3 -m pip install numpy wheel --break-system-packages
            
            echo '=== Building TFLite with SELECT_TF_OPS ==='
            bazel build -c opt \
              --config=monolithic \
              --define=tflite_with_select_tf_ops=true \
              --verbose_failures \
              //tensorflow/lite:libtensorflowlite.so \
              //tensorflow/lite/delegates/flex:tensorflowlite_flex
            
            echo '=== Copying libraries ==='
            mkdir -p /tmp/libs
            cp bazel-bin/tensorflow/lite/libtensorflowlite.so /tmp/libs/
            cp bazel-bin/tensorflow/lite/delegates/flex/libtensorflowlite_flex.so /tmp/libs/
            
            echo '=== Build complete ==='
            ls -lh /tmp/libs/
          "
        
        echo '=== Extracting libraries from container ==='
        docker cp builder:/tmp/libs ./libs
        ls -lh libs/
    
    - name: Create Docker image
      run: |
        cat > Dockerfile << 'DOCKER_EOF'
        FROM ubuntu:24.04
        
        RUN apt-get update && \
            apt-get install -y libstdc++6 && \
            rm -rf /var/lib/apt/lists/*
        
        COPY libs/*.so /usr/local/lib/
        RUN ldconfig
        
        # Verify libraries
        RUN ls -lh /usr/local/lib/libtensorflow*
        
        WORKDIR /app
        CMD ["bash"]
        DOCKER_EOF
        
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19 .
        docker tag ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19 \
          ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:latest
    
    - name: Push to Docker Hub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:latest
        echo "✅ Done: ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-libs-2.19
        path: libs/
        retention-days: 7
