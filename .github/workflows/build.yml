name: Build TFLite with Flex

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h
    
    - name: Login to SGS Registry
      uses: docker/login-action@v3
      with:
        registry: sgs-registry.snucse.org
        username: ${{ secrets.SGS_USERNAME }}
        password: ${{ secrets.SGS_CLI_SECRET }}
    
    - name: Build TFLite
      run: |
        docker run --name builder \
          tensorflow/tensorflow:latest-devel \
          bash -c "
            cd /tensorflow_src
            bazel build -c opt \
              --config=monolithic \
              --define=tflite_with_select_tf_ops=true \
              //tensorflow/lite:libtensorflowlite.so \
              //tensorflow/lite/delegates/flex:tensorflowlite_flex
            
            mkdir -p /tmp/libs
            cp bazel-bin/tensorflow/lite/libtensorflowlite.so /tmp/libs/
            cp bazel-bin/tensorflow/lite/delegates/flex/libtensorflowlite_flex.so /tmp/libs/
          "
        
        docker cp builder:/tmp/libs ./libs
        ls -lh libs/
    
    - name: Create Docker image
      run: |
        cat > Dockerfile << 'DOCKER_EOF'
        FROM ubuntu:22.04
        RUN apt-get update && apt-get install -y libstdc++6 && rm -rf /var/lib/apt/lists/*
        COPY libs/*.so /usr/local/lib/
        RUN ldconfig
        WORKDIR /app
        CMD ["bash"]
        DOCKER_EOF
        
        docker build -t sgs-registry.snucse.org/ws-5y8frda38hqz1/tflite-flex:latest .
    
    - name: Push image
      run: |
        docker push sgs-registry.snucse.org/ws-5y8frda38hqz1/tflite-flex:latest
        echo "âœ… Done: sgs-registry.snucse.org/ws-5y8frda38hqz1/tflite-flex:latest"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: tflite-libs
        path: libs/
