name: Build TFLite with Flex

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build TFLite (TensorFlow 2.19)
      run: |
        docker run --name builder \
          tensorflow/tensorflow:2.19.0 \
          bash -c "
            cd /tensorflow_src
            bazel build -c opt \
              --config=monolithic \
              --define=tflite_with_select_tf_ops=true \
              //tensorflow/lite:libtensorflowlite.so \
              //tensorflow/lite/delegates/flex:tensorflowlite_flex
            
            mkdir -p /tmp/libs
            cp bazel-bin/tensorflow/lite/libtensorflowlite.so /tmp/libs/
            cp bazel-bin/tensorflow/lite/delegates/flex/libtensorflowlite_flex.so /tmp/libs/
          "
        
        docker cp builder:/tmp/libs ./libs
        ls -lh libs/
    
    - name: Create Docker image
      run: |
        cat > Dockerfile << 'DOCKER_EOF'
        FROM ubuntu:22.04
        RUN apt-get update && apt-get install -y libstdc++6 && rm -rf /var/lib/apt/lists/*
        COPY libs/*.so /usr/local/lib/
        RUN ldconfig
        WORKDIR /app
        CMD ["bash"]
        DOCKER_EOF
        
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19 .
        docker tag ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19 \
          ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:latest
    
    - name: Push to Docker Hub
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:latest
        echo "âœ… Done: ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-libs-2.19
        path: libs/
