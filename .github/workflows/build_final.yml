name: Build TFLite SDK (Final Fix)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build_final.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 600
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Free Space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
        sudo apt-get clean

    - name: Create Build Script
      run: |
        cat << 'EOF' > build.sh
        #!/bin/bash
        set -e
        
        echo "=== 1. Setup Environment ==="
        apt-get update
        apt-get install -y git wget build-essential python3 python3-pip openjdk-11-jdk zip rsync tree
        
        wget -q https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-linux-x86_64 -O /usr/local/bin/bazel
        chmod +x /usr/local/bin/bazel
        
        git clone --depth 1 --branch v2.19.0 https://github.com/tensorflow/tensorflow.git /tf
        cd /tf
        python3 -m pip install numpy wheel --break-system-packages
        
        echo "=== 2. Bazel Build (Libs + Dependency Tracking) ==="
        bazel build -c opt --config=monolithic --define=tflite_with_select_tf_ops=true \
          --experimental_show_artifacts \
          //tensorflow/lite:libtensorflowlite.so \
          //tensorflow/lite/delegates/flex:libtensorflowlite_flex.so 2>&1 | tee /tmp/build.log
        
        mkdir -p /sdk/{lib,include}
        cp bazel-bin/tensorflow/lite/*.so /sdk/lib/
        
        echo "=== 3. Header Extraction (Nuclear Mode) ==="
        
        # (1) Source Headers
        echo "-> Copying source headers..."
        rsync -a --include='*/' --include='*.h' --include='*.hpp' --include='*.inc' --exclude='*' \
          /tf/tensorflow/ /sdk/include/tensorflow/
        
        # (2) Generated Headers (bazel-bin)
        echo "-> Copying bazel-bin headers..."
        find /tf/bazel-bin -type f \( -name '*.h' -o -name '*.hpp' -o -name '*.inc' -o -name '*.pb.h' \) 2>/dev/null | \
          while read f; do
            rel="${f#/tf/bazel-bin/}"
            mkdir -p "/sdk/include/$(dirname "$rel")"
            cp "$f" "/sdk/include/$rel"
          done
        
        # (3) Generated Headers (bazel-out)
        echo "-> Copying bazel-out headers..."
        if [ -d /tf/bazel-out ]; then
          find /tf/bazel-out -type f \( -name '*.h' -o -name '*.pb.h' -o -name '*.inc' \) 2>/dev/null | \
            grep -E '(genfiles|bin)' | \
            while read f; do
              if echo "$f" | grep -q 'tensorflow/'; then
                rel=${f#*/tensorflow/}
                mkdir -p "/sdk/include/tensorflow/$(dirname "$rel")"
                cp "$f" "/sdk/include/tensorflow/$rel" 2>/dev/null || true
              fi
            done
        fi
        
        # (4) External Dependencies
        echo "-> Copying external headers..."
        BAZEL_ROOT=$(readlink -f /tf/bazel-tensorflow_src 2>/dev/null || echo /tf/bazel-tf)
        
        if [ -d "$BAZEL_ROOT/external" ]; then
          cd "$BAZEL_ROOT/external"
          for lib in com_google_protobuf com_google_absl flatbuffers eigen_archive \
                     gemmlowp ruy cpuinfo pthreadpool FP16 farmhash ml_dtypes; do
            if [ -d "$lib" ]; then
              echo "Processing $lib..."
              find "$lib" -type f \( -name '*.h' -o -name '*.hpp' -o -name '*.inc' \) 2>/dev/null | \
                while read hdr; do
                  rel_path="${hdr#$lib/}"
                  
                  if [ "$lib" = "com_google_protobuf" ]; then
                    if echo "$rel_path" | grep -q '^src/'; then rel_path="${rel_path#src/}"; fi
                  elif [ "$lib" = "flatbuffers" ]; then
                    if echo "$rel_path" | grep -q '^include/'; then rel_path="${rel_path#include/}"; fi
                  elif [ "$lib" = "ml_dtypes" ]; then
                     :
                  fi
                  
                  target="/sdk/include/$rel_path"
                  mkdir -p "$(dirname "$target")"
                  cp "$hdr" "$target" 2>/dev/null || true
                done
            fi
          done
        fi
        
        echo "=== 4. Helper Scripts Generation ==="
        
        # Compile Helper
        cat > /sdk/compile.sh << 'EOFCOMPILE'
        #!/bin/bash
        set -e
        if [ $# -lt 2 ]; then echo "Usage: $0 <source.cpp> <output_bin>"; exit 1; fi
        SDK="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        SOURCE="$1"
        OUTPUT="$2"
        INCLUDES="-I$SDK/include -I$SDK/include/tensorflow"
        if [ -d $SDK/include ]; then
          for dir in $(find $SDK/include -mindepth 1 -maxdepth 2 -type d); do
            INCLUDES="$INCLUDES -I$dir"
          done
        fi
        echo "Compiling $SOURCE..."
        g++ -o "$OUTPUT" "$SOURCE" \
          -std=c++17 -O3 -DPLATFORM_POSIX \
          $INCLUDES \
          -L$SDK/lib \
          -ltensorflowlite -ltensorflowlite_flex \
          -ldl -lpthread \
          -Wl,-rpath,$SDK/lib
        echo "✅ Success: $OUTPUT"
        EOFCOMPILE
        chmod +x /sdk/compile.sh
        
        # Run Helper
        cat > /sdk/run.sh << 'EOFRUN'
        #!/bin/bash
        SDK="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="$SDK/lib:$LD_LIBRARY_PATH"
        exec "$@"
        EOFRUN
        chmod +x /sdk/run.sh

        # -------------------------------------------------------------
        # 5. Verification
        # -------------------------------------------------------------
        echo "=== 5. Verification Test ==="
        cat > /sdk/example.cpp << 'EOFTEST'
        #include <iostream>
        #include "tensorflow/lite/interpreter.h"
        #include "tensorflow/lite/kernels/register.h"
        #include "tensorflow/lite/delegates/flex/delegate.h"

        int main() {
            std::cout << "Testing TFLite SDK...\n";
            tflite::ops::builtin::BuiltinOpResolver resolver;
            auto delegate = tflite::FlexDelegate::Create();
            std::cout << "✅ SDK Works! Flex Delegate Created.\n";
            return 0;
        }
        EOFTEST

        echo "Attempting to compile example..."
        cd /sdk
        if ./compile.sh example.cpp test_bin 2>&1 | tee /tmp/test.log; then
            echo "Compilation Success!"
        else
            echo "❌ Compilation Failed! Printing Error Log:"
            cat /tmp/test.log
        fi

        echo "Attempting to run example..."
        if [ -f test_bin ]; then
             ./run.sh ./test_bin
             echo "✅✅✅ VERIFICATION PASSED ✅✅✅"
        else
             echo "⚠️ Test binary not found. Skipping execution."
        fi
        
        echo "=== 6. Packaging ==="
        cd /
        zip -q -r sdk.zip sdk/
        ls -lh sdk.zip
        EOF
        
        chmod +x build.sh

    - name: Build SDK inside Docker
      run: |
        docker run --name builder \
          -v ${{ github.workspace }}:/workspace \
          ubuntu:24.04 \
          /workspace/build.sh
        
        docker cp builder:/sdk.zip ./tflite_sdk_full.zip

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: tflite_sdk_full
        path: tflite_sdk_full.zip
        retention-days: 30
