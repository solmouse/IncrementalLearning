name: Build TFLite SDK ARM64

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build_with_header_arm.yml'
      - 'scripts/build_tflite_arm64.sh'

jobs:
  build_sdk:
    runs-on: ubuntu-latest
    timeout-minutes: 500
    
    steps:
    - name: Checkout User Repo
      uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo apt-get clean
        df -h
    
    - name: Set up QEMU for Docker Cross-compilation
      run: |
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Build and Package SDK inside Docker
      run: |
        docker run --name builder \
          -v ${{ github.workspace }}:/workspace \
          ubuntu:24.04 \
          bash /workspace/scripts/build_tflite_arm64.sh
        
        echo '=== Extracting SDK from container ==='
        docker cp builder:/tmp/tflite_sdk_arm64.zip ./tflite_sdk_arm64.zip
        ls -lh tflite_sdk_arm64.zip

    - name: Upload SDK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tflite_sdk_arm64
        path: tflite_sdk_arm64.zip
        retention-days: 7