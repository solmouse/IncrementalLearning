name: Build TFLite SDK ARM64

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build_with_header_arm.yml'

jobs:
  build_sdk:
    runs-on: ubuntu-latest
    timeout-minutes: 500
    
    steps:
    - name: Checkout User Repo
      uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        # GitHub Actions í™˜ê²½ì˜ ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo apt-get clean
        df -h
    
    # ðŸ’¡ [í•µì‹¬ ì¶”ê°€] x86 Runnerì—ì„œ ARM64 ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ QEMU ì„¤ì •
    - name: Set up QEMU for Docker Cross-compilation
      run: |
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Build and Package SDK inside Docker
      run: |
        # ðŸ’¡ [ARM64 Environment] ARM64ìš© ë°”ì´ë„ˆë¦¬ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ubuntu:24.04 (x86) ì»¨í…Œì´ë„ˆ ì‚¬ìš©
        docker run --name builder \
          -v ${{ github.workspace }}:/workspace \
          ubuntu:24.04 \
          bash -c "
            set -e
            
            echo '=== 1. Install Basic Tools & Cross-Compilation Tools ==='
            apt-get update
            # ðŸ’¡ ARM64 í¬ë¡œìŠ¤ ì»´íŒŒì¼ëŸ¬ ì„¤ì¹˜
            apt-get install -y git wget curl build-essential python3 python3-pip python3-dev openjdk-11-jdk zip unzip \
              gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            
            # ðŸ’¡ [ìˆ˜ì •] Bazelì€ TF ì†ŒìŠ¤ ë‚´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ ì‹¤í–‰ (ì™¸ë¶€ wget ì œê±°)
            
            echo '=== 2. Clone TensorFlow 2.19.0 ==='
            git clone --depth 1 --branch v2.19.0 https://github.com/tensorflow/tensorflow.git /tensorflow_src
            cd /tensorflow_src
            
            echo '=== 3. Python Dependencies ==='
            python3 -m pip install numpy wheel --break-system-packages

            echo '=== 4. Configure ARM64 CROSSTOOL ==='
            # CROSSTOOL íŒŒì¼ ìƒì„± (Bazelì´ í¬ë¡œìŠ¤ ì»´íŒŒì¼ëŸ¬ ê²½ë¡œë¥¼ ì°¾ë„ë¡ ì„¤ì •)
            mkdir -p tools/arm_compiler
            cat > tools/arm_compiler/BUILD << 'BEOF'
package(default_visibility = ['//visibility:public'])
BEOF

            cat > tools/arm_compiler/CROSSTOOL << 'CEOF'
major_version: \"local\"
minor_version: \"\"
default_target_cpu: \"aarch64\"

default_toolchain {
  cpu: \"aarch64\"
  toolchain_identifier: \"aarch64-cross-toolchain\"
}

toolchain {
  abi_version: \"aarch64\"
  abi_libc_version: \"aarch64\"
  builtin_sysroot: \"\"
  compiler: \"compiler\"
  host_system_name: \"local\"
  needsPic: true
  supports_gold_linker: false
  supports_incremental_linker: false
  supports_fission: false
  supports_interface_shared_objects: false
  supports_normalizing_ar: false
  supports_start_end_lib: false
  target_libc: \"aarch64\"
  target_cpu: \"aarch64\"
  target_system_name: \"aarch64\"
  toolchain_identifier: \"aarch64-cross-toolchain\"

  tool_path { name: \"ar\" path: \"/usr/bin/aarch64-linux-gnu-ar\" }
  tool_path { name: \"compat-ld\" path: \"/usr/bin/aarch64-linux-gnu-ld\" }
  tool_path { name: \"cpp\" path: \"/usr/bin/aarch64-linux-gnu-cpp\" }
  tool_path { name: \"dwp\" path: \"/usr/bin/aarch64-linux-gnu-dwp\" }
  tool_path { name: \"gcc\" path: \"/usr/bin/aarch64-linux-gnu-gcc\" }
  tool_path { name: \"gcov\" path: \"/usr/bin/aarch64-linux-gnu-gcov\" }
  tool_path { name: \"ld\" path: \"/usr/bin/aarch64-linux-gnu-ld\" }
  tool_path { name: \"nm\" path: \"/usr/bin/aarch64-linux-gnu-nm\" }
  tool_path { name: \"objcopy\" path: \"/usr/bin/aarch64-linux-gnu-objcopy\" }
  tool_path { name: \"objdump\" path: \"/usr/bin/aarch64-linux-gnu-objdump\" }
  tool_path { name: \"strip\" path: \"/usr/bin/aarch64-linux-gnu-strip\" }

  compiler_flag: \"-U_FORTIFY_SOURCE\"
  compiler_flag: \"-D_FORTIFY_SOURCE=1\"
  compiler_flag: \"-fstack-protector\"
  compiler_flag: \"-Wall\"
  compiler_flag: \"-Wunused-but-set-parameter\"
  compiler_flag: \"-Wno-free-nonheap-object\"
  compiler_flag: \"-fno-omit-frame-pointer\"
  compiler_flag: \"-Wno-deprecated-declarations\"

  cxx_flag: \"-std=c++17\"

  linker_flag: \"-lstdc++\"
  linker_flag: \"-lm\"
  linker_flag: \"-lpthread\"

  cxx_builtin_include_directory: \"/usr/aarch64-linux-gnu/include\"
  cxx_builtin_include_directory: \"/usr/lib/gcc-cross/aarch64-linux-gnu/13/include\"

  objcopy_embed_flag: \"-I\"
  objcopy_embed_flag: \"binary\"

  unfiltered_cxx_flag: \"-fno-canonical-system-headers\"
  unfiltered_cxx_flag: \"-Wno-builtin-macro-redefined\"
  unfiltered_cxx_flag: \"-D__DATE__=\\\"redacted\\\"\"
  unfiltered_cxx_flag: \"-D__TIMESTAMP__=\\\"redacted\\\"\"
  unfiltered_cxx_flag: \"-D__TIME__=\\\"redacted\\\"\"

  compilation_mode_flags {
    mode: DBG
    compiler_flag: \"-g\"
  }
  compilation_mode_flags {
    mode: OPT
    compiler_flag: \"-g0\"
    compiler_flag: \"-O3\"
    compiler_flag: \"-DNDEBUG\"
    compiler_flag: \"-ffunction-sections\"
    compiler_flag: \"-fdata-sections\"
    linker_flag: \"-Wl,--gc-sections\"
  }

  linking_mode_flags { mode: DYNAMIC }
}
CEOF

            echo 'âœ“ CROSSTOOL configured'
            
            echo '=== 6. Configure .bazelrc (AFTER CROSSTOOL) ==='
            cat >> .bazelrc << 'BZEF'

# ARM64 Cross-Compilation Configuration
build:rpi --crosstool_top=//tools/arm_compiler:toolchain
build:rpi --cpu=aarch64
build:rpi --host_crosstool_top=@bazel_tools//tools/cpp:toolchain
build:rpi --copt=-march=armv8-a
build:rpi --copt=-O3
BZEF

            echo 'âœ“ .bazelrc configured'
            
            echo '=== 7. Build for ARM64 ==='
            # ðŸ’¡ [ìˆ˜ì •] TF ì†ŒìŠ¤ ë‚´ì˜ tools/bazel ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ (ê°€ìž¥ ì•ˆì •ì ìž„)
            /tensorflow_src/tools/bazel build -c opt \
              --config=monolithic \
              --config=rpi \
              --define=tflite_with_select_tf_ops=true \
              --verbose_failures \
              --jobs=4 \
              //tensorflow/lite:libtensorflowlite.so \
              //tensorflow/lite/delegates/flex:libtensorflowlite_flex.so

            echo '=== 8. Verify ARM64 Binaries ==='
            file bazel-bin/tensorflow/lite/libtensorflowlite.so
            file bazel-bin/tensorflow/lite/delegates/flex/libtensorflowlite_flex.so
            
            echo '=== 9. Packaging SDK ==='
            mkdir -p /tmp/sdk/include
            mkdir -p /tmp/sdk/lib
            
            echo 'Copying Libraries...'
            cp bazel-bin/tensorflow/lite/libtensorflowlite.so /tmp/sdk/lib/
            cp bazel-bin/tensorflow/lite/delegates/flex/libtensorflowlite_flex.so /tmp/sdk/lib/
            
            echo 'Copying Source Headers...'
            find tensorflow \( -name '*.h' -o -name '*.hpp' -o -name '*.inc' \) -exec cp --parents {} /tmp/sdk/include/ \;

            echo 'Copying Generated Headers...'
            cd bazel-bin
            find tensorflow \( -name '*.pb.h' -o -name '*.inc' \) -exec cp --parents {} /tmp/sdk/include/ \;
            cd /tensorflow_src
            
            echo 'Copying External Dependencies...'
            
            # FlatBuffers
            FB_HEADER=\$(find -L . -name 'flatbuffers.h' | grep 'external/flatbuffers' | head -n 1)
            if [ -n \"\$FB_HEADER\" ]; then
               FB_ROOT=\$(dirname \$(dirname \"\$FB_HEADER\"))
               echo \"Found FlatBuffers at: \$FB_ROOT\"
               cp -r \"\$FB_ROOT/flatbuffers\" /tmp/sdk/include/
            fi
            
            # Abseil
            ABSL_HEADER=\$(find -L . -name 'string_view.h' | grep 'external/com_google_absl' | head -n 1)
            if [ -n \"\$ABSL_HEADER\" ]; then
               ABSL_ROOT=\$(dirname \$(dirname \$(dirname \"\$ABSL_HEADER\")))
               echo \"Found Abseil at: \$ABSL_ROOT\"
               cp -r \"\$ABSL_ROOT/absl\" /tmp/sdk/include/
            fi

            # Eigen
            EIGEN_HEADER=\$(find -L . -name 'Core' | grep 'external/eigen_archive/Eigen' | head -n 1)
            if [ -n \"\$EIGEN_HEADER\" ]; then
               EIGEN_ROOT=\$(dirname \$(dirname \"\$EIGEN_HEADER\"))
               echo \"Found Eigen at: \$EIGEN_ROOT\"
               cp -r \"\$EIGEN_ROOT/Eigen\" /tmp/sdk/include/
               cp -r \"\$EIGEN_ROOT/unsupported\" /tmp/sdk/include/ || true
            fi
            
            # Gemmlowp
            GEMM_HEADER=\$(find -L . -name 'fixedpoint.h' | grep 'external/gemmlowp' | head -n 1)
            if [ -n \"\$GEMM_HEADER\" ]; then
               GEMM_ROOT=\$(dirname \$(dirname \"\$GEMM_HEADER\"))
               echo \"Found Gemmlowp at: \$GEMM_ROOT\"
               mkdir -p /tmp/sdk/include/fixedpoint
               cp -r \"\$GEMM_ROOT/fixedpoint\" /tmp/sdk/include/
               cp -r \"\$GEMM_ROOT/internal\" /tmp/sdk/include/ || true
            fi
            
            # NEON_2_SSE
            NEON_HEADER=\$(find -L . -name 'NEON_2_SSE.h' | grep 'external' | head -n 1)
            if [ -n \"\$NEON_HEADER\" ]; then
               echo \"Found NEON_2_SSE\"
               cp \"\$NEON_HEADER\" /tmp/sdk/include/
            fi
            
            echo '=== 10. Build Info ==='
            cat > /tmp/sdk/BUILD_INFO.txt << 'INFO_EOF'
TensorFlow Lite SDK (ARM64)
===========================
Target: ARM64 (aarch64)
TensorFlow: 2.19.0
Bazel: 6.5.0
Host: x86_64 Ubuntu 24.04
Cross-Compiled: Yes

Contents:
- lib/libtensorflowlite.so (ARM64)
- lib/libtensorflowlite_flex.so (ARM64)
- include/ (headers)

Usage on Raspberry Pi 4/5:
 g++ main.cpp \
  -I./include \
  -L./lib \
  -ltensorflowlite \
  -ltensorflowlite_flex \
  -lpthread -ldl -lm \
  -std=c++17 \
  -Wl,-rpath,'$ORIGIN/lib' \
  -o app

Verify binaries:
 file lib/libtensorflowlite.so
 # Should show: ARM aarch64
INFO_EOF
            
            echo '=== 11. Zip SDK ==='
            cd /tmp
            zip -r tflite_sdk_arm64.zip sdk/
            ls -lh tflite_sdk_arm64.zip
          "
        
        echo '=== Extracting SDK from container ==='
        docker cp builder:/tmp/tflite_sdk_arm64.zip ./tflite_sdk_arm64.zip
        ls -lh tflite_sdk_arm64.zip

    - name: Upload SDK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tflite_sdk_arm64
        path: tflite_sdk_arm64.zip
        retention-days: 7
