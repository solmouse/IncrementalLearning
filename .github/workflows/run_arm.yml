name: Verify TFLite ARM64

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/verify_tflite_arm64.yml'
      - 'scripts/verify_tflite_arm64.sh'
      - 'pi/cpp_pi_test_251208/tflite_sdk_arm64.tar.gz' 

jobs:
  verify_arm64:
    name: Verify and Run ARM64 Binary via QEMU
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout User Repo
        uses: actions/checkout@v4
        
      - name: Unpack TFLite SDK
        run: |
          SDK_FILE="pi/cpp_pi_test_251208/tflite_sdk_arm64.tar.gz"
          tar -xzvf ${SDK_FILE}
          echo "Unpacked SDK directory structure:"
          ls -lR sdk/
          
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Run Verification (ARM64 Container)
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            ubuntu:24.04 \
            bash /workspace/scripts/verify_tflite_arm64.sh