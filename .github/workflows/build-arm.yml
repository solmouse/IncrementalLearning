name: Build TFLite with Flex (ARM64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-arm.yml'

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    timeout-minutes: 500
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo apt-get clean
        df -h
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build TFLite 2.19 for ARM64 (Raspberry Pi)
      run: |
        docker run --name builder \
          ubuntu:22.04 \
          bash -c "
            set -e
            
            echo '=== Installing dependencies ==='
            apt-get update
            apt-get install -y \
              git wget curl \
              build-essential \
              crossbuild-essential-arm64 \
              python3 python3-pip python3-dev \
              openjdk-11-jdk \
              zip unzip
            
            echo '=== Installing Bazel 6.5.0 ==='
            wget -q https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-linux-x86_64 -O /usr/local/bin/bazel
            chmod +x /usr/local/bin/bazel
            bazel --version
            
            echo '=== Cloning TensorFlow 2.19.0 ==='
            git clone --depth 1 --branch v2.19.0 https://github.com/tensorflow/tensorflow.git /tensorflow_src
            cd /tensorflow_src
            
            echo '=== Installing Python dependencies ==='
            python3 -m pip install --upgrade pip
            python3 -m pip install numpy wheel
            
            echo '=== Building TFLite for ARM64 (aarch64) ==='
            bazel build -c opt \
              --config=elinux_aarch64 \
              --config=monolithic \
              --define=tflite_with_select_tf_ops=true \
              --verbose_failures \
              //tensorflow/lite:libtensorflowlite.so \
              //tensorflow/lite/delegates/flex:tensorflowlite_flex
            
            echo '=== Copying libraries ==='
            mkdir -p /tmp/libs
            cp bazel-bin/tensorflow/lite/libtensorflowlite.so /tmp/libs/
            cp bazel-bin/tensorflow/lite/delegates/flex/libtensorflowlite_flex.so /tmp/libs/
            
            echo '=== Build complete ==='
            ls -lh /tmp/libs/
            file /tmp/libs/*.so
          "
        
        echo '=== Extracting libraries from container ==='
        docker cp builder:/tmp/libs ./libs-arm64
        ls -lh libs-arm64/
        file libs-arm64/*.so
    
    - name: Create Docker image (ARM64 multi-arch)
      run: |
        # ARM64용 이미지는 실제 ARM 환경에서 실행 가능
        cat > Dockerfile.arm64 << 'DOCKER_EOF'
        FROM arm64v8/ubuntu:22.04
        
        RUN apt-get update && \
            apt-get install -y libstdc++6 && \
            rm -rf /var/lib/apt/lists/*
        
        COPY libs-arm64/*.so /usr/local/lib/
        RUN ldconfig
        
        # Verify libraries
        RUN ls -lh /usr/local/lib/libtensorflow*
        
        WORKDIR /app
        CMD ["bash"]
        DOCKER_EOF
        
        # Buildx로 ARM64 이미지 빌드 (에뮬레이션)
        docker buildx create --use --name arm-builder || true
        docker buildx build --platform linux/arm64 \
          -f Dockerfile.arm64 \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19-arm64 \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:latest-arm64 \
          --push \
          .
    
    - name: Upload ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-libs-2.19-arm64
        path: libs-arm64/
        retention-days: 7
    
    - name: Build summary
      run: |
        echo "✅ ARM64 Build Complete!"
        echo ""
        echo "Docker Images:"
        echo "  - ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:2.19-arm64"
        echo "  - ${{ secrets.DOCKERHUB_USERNAME }}/tflite-flex:latest-arm64"
        echo ""
        echo "Libraries:"
        ls -lh libs-arm64/
        echo ""
        echo "File info:"
        file libs-arm64/*.so
